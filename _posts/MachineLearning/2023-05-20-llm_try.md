---

layout: post
title: 如何应用LLM
category: 架构
tags: MachineLearning
keywords: llm chatgpt gpt bert

---

## 简介

* TOC
{:toc}

早期的深度模型专模专用，严重依赖有监督学习，这就需要大量的任务相关的人工标注数据，代价昂贵。天下苦标注久矣，如果能够有一个与具体任务无关的大模型，只要利用任务相关的少量数据微调，就能够大杀四方，岂不美哉。

## 业务场景

[关于大模型技术的三点思考](https://mp.weixin.qq.com/s/NMadeQkDdoIzJzqVUZOGlQ)企业日常经营就是在不断地做决策并执行。决策就是说企业处理一个事情的时候，比如营销、分发，有很多种不同的做法，要选择什么样的做法。但决策类 AI 明显不好做。因为决策，上游需要高质量的数据作为输入，下游的具体服务得靠人提供。
1. 先说下游执行服务的人。人的不确定性太多了，你出策略，即使 AI 做得再好，只是辅助，执行如果不到位，数字化也不会有进展。 执行，过去我们是人主要驱动的，即使有 CRM、ERP、HR，都是靠人，用非数字化的方式执行了之后，把结果一项一项填到系统里面去。
2. 上游输入的数据也是个大问题。数据怎么来呢？完蛋了，执行的过程绝大多数企业压根没收集到数据。这里的“数据”，不是说你没有历史数据，而是你今天正在开展的业务里边没有足够的反馈数据。什么是反馈数据？员工跟企业之间的数据交换其实有三条通道。
    1. 接受信息、接受培训，比如视频、文字、PPT；
    2. 人与人之间的交流，跟同事跟主管跟客户的交流；
    3. 是用系统。
3. 做决策，我们只能用系统里边的这些数据去产生策略，但在这三条路径当中，系统能占多少？系统可能 5% 都占不到， 95% 的时间你是在阅读，在跟人聊天，在写 PPT、填表格、开会，所以95% 的数据都不在系统里。95%都是非结构化的、多模态的，我们没法抽象化、标准化，有的甚至都没法数据化。这是数据的困境。
4. 过去的信息化其实是把所有的业务步骤抽象为表单和流程。表单比如 Excel，有的企业自嘲说自己的数字化特别落后，都在 Excel 里边做，问题只是这些数据难以得到利用，怎么调各种视图，还是有门槛。现在已经把数据集成到对话机器人里了，输个指令，直接收到回答。企业可以大大扩展数据的边界，突破5%。
5. ChatGPT 让业界重拾了对 IM 机器人的重视，都认为对话框是数字化的最佳解法，这应该是轻物理资产、重人力要素的互联网企业的限定答案。在其他场景比如物流、驾驶、医疗中，人和机器的交互可能需要其他形式。医生做手术的时候能点对话框吗，不能，但他可以说话，这是一种交互状态；司机开车的时候能点对话框吗，也不能，但是可以用动作，这也是一种交互状态。所以 AIGC 这个事发展到未来，人和机器一定会是多模态的交互，而且是更接近于人的自然能力。IM 只是中间的一个过渡状态。

假设一个场景，我希望chatgpt是个咨询专家，他可以回答我的一些问题。我问chatgpt一些问题，它会基于外部数据库和自身的能力给我回复。
这里会有两个问题需要考虑：
1. 提问的技巧，就是现在人们在热烈讨论的prompt engineer
2. 如何利用外部知识

## 技术实现 

**LLM 距离 AGI 的一大差距是没法与真实世界连接**。[LLM 应用开发全栈指南](https://mp.weixin.qq.com/s/weH_7K2g3sBMbtei1_dTng)以 SQL 工具为例展示了下 LLM 如何来利用外部工具。大致为以下几个步骤：
1. 用户问了一个问题
2. 将用户问题和数据库的 meta 信息放到 prompt 里，让 LLM 去生成 SQL
3. 利用数据库来执行这个 SQL 查询，这就是工具的调用
4. 将数据库查询结果与问题再扔给 LLM 做最终回答

当然这个步骤可以说是由 Chain 定义固定下来的，也可以采用类似 agent/plugin 的方式来让 LLM 自行决定在何时使用什么工具。用户只需要提供 API 的 spec 和描述，就可以快速接入到 plugin 体系中。这两种方式主要的权衡在于可靠性或者是流程的确定程度。Chain 的运作流程是人工定义好的，流程不会出错，且对 LLM 来说生成具体的工具指令也会准确率更高。而 plugin 的优势在于极大的流程灵活度，可以用统一入口满足用户各类诉求。虽然可靠性会下降不少，但也可以考虑引入人工交互来弥补。

![](/public/upload/machine/use_llm.jpg)

[基于大语言模型构建知识问答系统](https://zhuanlan.zhihu.com/p/627655485) 
1. 传统搜索系统基于关键字匹配，在面向：游戏攻略、技术图谱、知识库等业务场景时，缺少对用户问题理解和答案二次处理能力。
2. 领域知识不在预训练的数据集中，比如：
    1. 较新的内容。同一个知识点不断变更：修改、删除、添加。如何反馈当前最新的最全面的知识。比如对于 ChatGpt 而言，训练数据全部来自于 2021.09 之前。
    2. 未公开的、未联网的内容。
3. 基于 LLM 搭建问答系统的解决方案有以下几种：
    1. Fine-Tuning
    2. 基于 Prompt Engineering，比如 Few-Shot方式。**将特定领域的知识作为输入消息提供给模型**。类似于短期记忆，容量有限但是清晰。举个例子给 ChatGPT 发送请求，将特定的知识放在请求中，让 ChatGPT 对消息中蕴含的知识进行分析，并返回处理结果。
    3. 与普通搜索结合，使用基础模型对搜索结果加工。在做问答时的方式就是把 query 转换成向量，然后在文档向量库中做相似度搜索。
        ![](/public/upload/machine/llm_with_knowledge_base.jpg)
    4. 用户输入query之后，首先先从知识库搜索到结果，然后基于搜索到的结果进行解析构造，生成新的prompt，然后调用LLM，LLM根据输入的prompt自行进行知识库的检索与plugins的调用
        ![](/public/upload/machine/use_llm_with_prompt.jpg)


LLM 擅长于一般的语言理解与推理，而不是某个具体的知识点。如何为ChatGPT/LLM大语言模型添加额外知识？
1. 通过fine-tuning来和新知识及私有数据进行对话
2. 通过word embeddings + pinecone数据库来搭建自己私有知识库。 chatgpt预训练完成后，会生成一个embeddings向量字典，比如我们可以将我们的私有知识库各个章节通过openai的相关api获取到对应的embeddings，然后将这些embeddings保存到向量数据库（比如 Facebook 开源的 Faiss库、Pinecone 和 Weaviate），当用户要对某个领域后者问题进行语义查询时，则将用户的输入同样通过openai的相关api来获取相应的embeddings向量，然后再和向量数据库pinecone中的我们的私有知识库类型做**语义相似度查询**，然后返回给用户。
    1. 比如判断某一段文本 是积极还是消极，向chatgpt 查询目标文本的向量，然后计算其与“积极” “消极” 两个词 embedding 向量的“距离”，谁更近，说明这段文本更偏向于积极或消极。
    2. 过几天openAI的模型版本升级了，这些保存的embedding会失效吗？特定模型也有带日期的快照版本，选取那些快照版本就好了。
3. 通过langchain这个chatgpt编程框架来给chatgpt赋能。 langchain可以将不同的工具模块和chatgpt给链接（chain）起来。
4. chatgpt 插件

## 是否自建大模型

[自建行业大模型的思考](https://zhuanlan.zhihu.com/p/625186095)

应用场景
1. 企业内部应用：主要作用于帮助企业员工更好的完成本职工作，提升工作效率
2. 企业对外业务：将LLM封装成一个产品，销售给客户

是否需要构建行业大模型？
1. 通用 LLM会不会大力出奇迹，在没有经过专业领域数据训练的条件下就可以很好的完成专业领域任务？BloombergGPT的论文中实现表明：基于专业领域语料训练的大模型，在领域内的理解要超过通用大模型；
2. 能否通过为Prompt填充领域知识的方式，让LLM具备解决专业领域任务的能力？可以，角色扮演就是一个例子
    1. 优点：灵活多变，可以适应各种场景，几乎没有训练成本，所有的行业知识通过prompt注入
    2. 缺点：大量领域知识会限制多轮对话或者prompt构造，模型输入有长度限制，如果加入了较多领域知识，就没有空间留给理会对话以及prompt；对于专业词汇的理解可能不准确
3.  能否通过检索的方式，从本地知识库中查找出符合要求的答案返回？可以，例如：插件、AutoGPT
    1. 优点：没有训练成本；返回结果完全可控，即知识库内容
    2. 缺点：大模型+检索的方式分成两步走，性能会较慢；回答内容单一，缺乏泛化性；对于专业词汇的理解可能不准确

自建 or 购买
1. 购买。数据安全风险；缺乏商业护城河；不够灵活：新的需求和模型效果提升可能需要重新签订协议购买
2. 自建。训练成本较高：数据成本、算力成本、试错成本；模型效果难以保证；对于模型训练算法工程师有较高要求

自建大语言模型可能遇到的问题
1. 容易解决的问题
    1. 模型训练方案容易实现，现阶段开源LLM都有完善的训练和推理流程；
    2. 效果优异的基座模型，虽然中文开源LLM效果还没有英文的那么多、那么好，但是也已经达到了够用的水平；
2. 不容易解决的问题
    1. 明确的LLM需求
        1. 高级收益需求：某个功能以前无法实现，LLM可以助力实现，并为公司带来较高收益；
        2. 次级收益需求：某个已经实现的功能，LLM可以对其优化，降本增效；
    2. 训练数据难以构建，训练数据应该具备一下特征：训练大模型需要巨量数据；涵盖多种问题，同一问题还应该有多种表达方式；数据应该尽量准确，不能含有有毒数据；要包含大量通用文本语料，在二次训练过程中会有灾难性遗忘问题，需要通用语料保持LLM通用语言能力；要包含本公司业务领域的文本语料，提升LLM对于行业数据理解能力；最好包含多轮对话语料，使模型具备连续对话的能力；最好能有同一个问题的不同得分的回答，实现RLHF的训练
    3. 部署成本高昂：LLM模型参数量巨大，一般自建模型参数量最小是7B，需要占用大量显存；即使使用量化技术，推理服务QPS也不会很高；使用量化技术会让模型虽然会提升性能，降低显存占用，但是会极大损害效果；较长的sequence length会占用大量的显存，增加计算消耗（时间复杂度是sequence length的平方）；高性能GPU服务器成本较高
    4. 大语言模型生成结果不可控：生成模型普遍存在生成结果不可控的问题；需要尝试不同的prompt才能得到令人满意的结果


[LLM 应用开发全栈指南](https://mp.weixin.qq.com/s/weH_7K2g3sBMbtei1_dTng) LLMOps
1. 选择基础模型
    1. 如果希望完全开放的使用，T5/Flan-T5 是个不错的选择，效果也还行。
    2. 开源可商用这块可以考虑最近的 Dolly，StableLM。
    3. 如果用于研究用途，LLaMA 系列是目前比较主流的。如果对于 2020 年的 GPT-3 复现与实验感兴趣，可以用 OPT。
    4. 其它基本不太用考虑，包括表上的 Bloom 和 GLM。不过这个表的更新迭代速度应该会很快。
2. Prompt 迭代开发
3. 测试，LLM 的能力非常强大，能处理各种任务，这对其评估造成了很大的困难，比如我们很难判断一篇总结是否比另外一篇总结写得更好。对于不同的 prompt，模型甚至 fine tune 的效果，如何进行快速，低成本且准确的评估是一个大问题。
4. 部署
5. 监控
4. 持续优化与 fine tune。 一般来说优先选择前者， 尤其是当前开源模型，fine tune 技术都没有那么成熟的情况下。什么时候需要 fine tune 呢？
    1. 你需要节省成本，比如用更小的模型，不想每次都带一大段 prompt 之类。
    2. 你有大量的数据，且 retrieval 的方法表现不够理想。

钱，算力，数据哪个会成为大模型继续 scale 的瓶颈？总体来说最有可能成为瓶颈的是数据。在特定数据量下即使是无限的参数量都没法打败拥有更多数据量训练出来的有限参数量的模型。因为 retrieval 模式非常有效，所以大家自然会有想法说是不是不需要那么大的模型来记住各种知识点，而只需要一个拥有推理能力的小模型就可以？小模型可以在手机端，机器人设备上直接部署使用，想象空间还是非常大的。